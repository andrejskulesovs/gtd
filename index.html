<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Getting Things Done</title>
    <!-- Add Quill stylesheet -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <!-- Add Flatpickr stylesheet -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
        }

        .header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .header > * {
            margin-right: 10px;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
        }
        .board {
            flex: 1;
            display: flex;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 20px;
        }

        .column {
            flex: 0 0 250px;
            margin-right: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            max-height: 100%;
        }

        .column-content {
            overflow-y: auto;
            flex-grow: 1;
        }
        .column h2 {
            margin-top: 0;
            padding: 10px;
            background-color: #d0d0d0;
            border-radius: 5px;
        }
        .task-card {
            background-color: white;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            cursor: move;
        }
        .task-card .project {
            font-size: 0.8em;
            padding: 2px 5px;
            border-radius: 3px;
            display: inline-block;
            margin-top: 5px;
        }
        .task-card .date {
            font-size: 0.8em;
            margin-top: 5px;
        }
        .task-card .date.overdue {
            background-color: #ffcccc;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .task-card .pomodoro {
            font-size: 0.8em;
            margin-top: 5px;
            color: #666;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 800px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        button:hover {
            opacity: 0.8;
        }
        .delete-btn {
            background-color: #ff4444;
            color: white;
        }
        .delete-btn:hover {
            background-color: #cc0000;
        }
        form {
            display: flex;
            flex-direction: column;
        }
        form label {
            margin-top: 10px;
            font-weight: bold;
        }
        form input[type="text"],
        form textarea,
        form select {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        form textarea {
            height: 100px;
            resize: vertical;
        }
        .form-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .save-btn {
            background-color: #4CAF50;
            color: white;
        }
        .cancel-btn {
            background-color: #f0f0f0;
            color: #333;
        }
        #projectList {
            list-style-type: none;
            padding: 0;
        }
        #projectList li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        .color-preview {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
        }
        #editor-container {
            height: 200px;
            margin-bottom: 10px;
        }
        .ql-editor {
            font-size: 14px;
        }
        .task-description {
            margin-top: 5px;
            font-size: 0.9em;
            max-height: 100px;
            overflow-y: auto;
        }
        .pomodoro-control {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        .pomodoro-control button {
            width: 30px;
            height: 30px;
            font-size: 18px;
            margin: 0 5px;
            padding: 0;
        }
        #taskPomodoro {
            width: 50px;
            text-align: center;
        }
        #projectWarnings {
            margin-bottom: 20px;
        }
        .project-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 5px;
            border-radius: 4px;
        }
        #projectFilter {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        #showArchiveCheckbox {
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button onclick="addNewTask()">Add New Task</button>
            <button onclick="openProjectModal()">Edit Projects</button>
        
            <span>Filter:</span>
            <select id="projectFilter" onchange="applyFilter()">
                <option value="">All Projects</option>
            </select>
            <label>
                <input type="checkbox" id="showArchiveCheckbox" onchange="toggleArchive()">
                Show Archive
            </label>
            <button onclick="document.getElementById('importFile').click()">Import Data</button>
            <button onclick="exportData()">Export Data</button>
            <input type="file" id="importFile" style="display: none;" onchange="importData(event)">
        </div>

        <div id="projectWarnings"></div>
    
        <div class="board" id="board"></div>
    </div>
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Task Details</h2>
            <form id="taskForm">
                <input type="hidden" id="taskId">
                <label for="taskName">Name:</label>
                <input type="text" id="taskName" required>
                
                <label for="editor-container">Description:</label>
                <div id="editor-container"></div>
                
                <label for="taskProject">Project:</label>
                <select id="taskProject"></select>
                
                <label for="taskStatus">Status:</label>
                <select id="taskStatus">
                    <option value="In">In</option>
                    <option value="Todo">Todo</option>
                    <option value="InProgress">In Progress</option>
                    <option value="Waiting">Waiting</option>
                    <option value="Done">Done</option>
                    <option value="Maybe">Maybe</option>
                    <option value="Refs">Refs</option>
                    <option value="Archive">Archive</option>
                </select>
                
                <label for="taskDate">Date:</label>
                <input type="text" id="taskDate">
                
                <label for="taskPomodoro">Pomodoro:</label>
                <div class="pomodoro-control">
                    <button type="button" onclick="decrementPomodoro()">-</button>
                    <input id="taskPomodoro" value="0" min="0" readonly>
                    <button type="button" onclick="incrementPomodoro()">+</button>
                </div>
                
                <div class="form-buttons">
                    <button type="submit" class="save-btn">Save</button>
                    <button type="button" class="cancel-btn" onclick="closeModal('taskModal')">Cancel</button>
                    <button type="button" class="delete-btn" onclick="deleteTask()">Delete Task</button>
                </div>
            </form>
        </div>
    </div>

    <div id="projectModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Edit Projects</h2>
            <form id="projectForm">
                <label for="projectName">Name:</label>
                <input type="text" id="projectName" required>
                
                <label for="projectColor">Color:</label>
                <input type="color" id="projectColor" required>
                
                <button type="submit" class="save-btn">Add Project</button>
            </form>
            <ul id="projectList"></ul>
        </div>
    </div>

    <!-- Add Quill library -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <!-- Add Flatpickr library -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        const statuses = ['In', 'Todo', 'InProgress', 'Waiting', 'Done', 'Maybe', 'Refs', 'Archive'];
        let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
        let projects = JSON.parse(localStorage.getItem('projects')) || [];
        let quill;
        let datepicker;

        function checkProjectWarnings() {
            const warningsContainer = document.getElementById('projectWarnings');
            warningsContainer.innerHTML = '';

            const activeStatuses = ['Todo', 'InProgress'];
            
            projects.forEach(project => {
                const hasActiveTasks = tasks.some(task => 
                    task.project === project.name && activeStatuses.includes(task.status)
                );

                if (!hasActiveTasks) {
                    const warningDiv = document.createElement('div');
                    warningDiv.className = 'project-warning';
                    warningDiv.textContent = `No active tasks for project: ${project.name}`;
                    warningsContainer.appendChild(warningDiv);
                }
            });
        }

        function renderBoard() {
            checkProjectWarnings();
            
            const board = document.getElementById('board');
            board.innerHTML = '';
            const selectedProject = document.getElementById('projectFilter').value;
            const showArchive = document.getElementById('showArchiveCheckbox').checked;
            
            statuses.forEach(status => {
                if (status === 'Archive' && !showArchive) return;
                
                const column = document.createElement('div');
                column.className = 'column';
                column.innerHTML = `<h2>${status}</h2><div class="column-content"></div>`;
                column.ondragover = allowDrop;
                column.ondrop = (event) => drop(event, status);
                const columnContent = column.querySelector('.column-content');
                const statusTasks = tasks.filter(task => 
                    task.status === status && 
                    (!selectedProject || task.project === selectedProject)
                );
                statusTasks.forEach(task => {
                    const taskCard = createTaskCard(task);
                    columnContent.appendChild(taskCard);
                });
                board.appendChild(column);
            });
        }

        function formatDate(date) {
            const d = new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            return `${day}-${month}-${year}`;
        }

        function createTaskCard(task) {
            const card = document.createElement('div');
            card.className = 'task-card';
            card.draggable = true;
            card.ondragstart = drag;
            card.onclick = () => openTaskModal(task);
            card.id = task.id;
            const project = projects.find(p => p.name === task.project);
            const backgroundColor = project ? project.color : '#ffffff';
            const textColor = getContrastColor(backgroundColor);
            
            let dateHtml = '';
            if (task.date) {
                const taskDate = new Date(task.date);
                const isOverdue = taskDate < new Date() && task.status !== 'Done';
                dateHtml = `<div class="date ${isOverdue ? 'overdue' : ''}">${formatDate(taskDate)}</div>`;
            }
            
            let pomodoroHtml = '';
            if (task.pomodoro && task.pomodoro > 0) {
                pomodoroHtml = `<div class="pomodoro">Pomodoro: ${task.pomodoro}</div>`;
            }
            
            card.innerHTML = `
                <div><strong>${task.name}</strong></div>
                <div class="project" style="background-color: ${backgroundColor}; color: ${textColor};">${task.project}</div>
                ${dateHtml}
                ${pomodoroHtml}
                <div class="task-description">${task.description}</div>
            `;
            return card;
        }

        function getContrastColor(hexcolor) {
            hexcolor = hexcolor.replace("#", "");
            var r = parseInt(hexcolor.substr(0,2),16);
            var g = parseInt(hexcolor.substr(2,2),16);
            var b = parseInt(hexcolor.substr(4,2),16);
            var yiq = ((r*299)+(g*587)+(b*114))/1000;
            return (yiq >= 128) ? 'black' : 'white';
        }

        function addNewTask() {
            openTaskModal();
        }

        function openTaskModal(task = null) {
            const modal = document.getElementById('taskModal');
            const form = document.getElementById('taskForm');
            const deleteBtn = document.querySelector('.delete-btn');
            const projectSelect = document.getElementById('taskProject');
            
            projectSelect.innerHTML = '';
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.name;
                option.textContent = project.name;
                projectSelect.appendChild(option);
            });

            if (task) {
                document.getElementById('taskId').value = task.id;
                document.getElementById('taskName').value = task.name;
                quill.root.innerHTML = task.description;
                document.getElementById('taskProject').value = task.project;
                document.getElementById('taskStatus').value = task.status;
                document.getElementById('taskDate').value = task.date || '';
                document.getElementById('taskPomodoro').value = task.pomodoro || 0;
                deleteBtn.style.display = 'inline-block';
            } else {
                form.reset();
                document.getElementById('taskId').value = '';
                quill.root.innerHTML = '';
                document.getElementById('taskPomodoro').value = 0;
                deleteBtn.style.display = 'none';
            }
            modal.style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        document.querySelectorAll('.close').forEach(closeBtn => {
            closeBtn.onclick = () => closeModal(closeBtn.closest('.modal').id);
        });

        document.getElementById('taskForm').onsubmit = function(e) {
            e.preventDefault();
            const taskId = document.getElementById('taskId').value;
            const task = {
                id: taskId || Date.now().toString(),
                name: document.getElementById('taskName').value,
                description: quill.root.innerHTML,
                project: document.getElementById('taskProject').value,
                status: document.getElementById('taskStatus').value,
                date: document.getElementById('taskDate').value,
                pomodoro: parseInt(document.getElementById('taskPomodoro').value, 10)
            };
            if (taskId) {
                const index = tasks.findIndex(t => t.id === taskId);
                tasks[index] = task;
            } else {
                tasks.push(task);
            }
            saveTasks();
            renderBoard();
            closeModal('taskModal');
        };

        function deleteTask() {
            const taskId = document.getElementById('taskId').value;
            if (taskId) {
                if (confirm('Are you sure you want to delete this task?')) {
                    tasks = tasks.filter(t => t.id !== taskId);
                    saveTasks();
                    renderBoard();
                    closeModal('taskModal');
                }
            }
        }

        function saveTasks() {
            localStorage.setItem('tasks', JSON.stringify(tasks));
        }

        function saveProjects() {
            localStorage.setItem('projects', JSON.stringify(projects));
            populateProjectFilter();
        }

        function openProjectModal() {
            const modal = document.getElementById('projectModal');
            renderProjectList();
            modal.style.display = 'block';
        }

        document.getElementById('projectForm').onsubmit = function(e) {
            e.preventDefault();
            const projectName = document.getElementById('projectName').value;
            const projectColor = document.getElementById('projectColor').value;
            projects.push({ name: projectName, color: projectColor });
            saveProjects();
            renderProjectList();
            this.reset();
        };

        function renderProjectList() {
            const projectList = document.getElementById('projectList');
            projectList.innerHTML = '';
            projects.forEach(project => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>
                        <span class="color-preview" style="background-color: ${project.color};"></span>
                        ${project.name}
                    </span>
                    <button onclick="deleteProject('${project.name}')">Delete</button>
                `;
                projectList.appendChild(li);
            });
        }

        function deleteProject(projectName) {
            if (confirm(`Are you sure you want to delete project "${projectName}"?`)) {
                projects = projects.filter(p => p.name !== projectName);
                tasks = tasks.map(t => t.project === projectName ? {...t, project: ''} : t);
                saveProjects();
                saveTasks();
                renderProjectList();
                renderBoard();
            }
        }

        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.id);
        }

        function drop(ev, status) {
            ev.preventDefault();
            const taskId = ev.dataTransfer.getData("text");
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.status = status;
                saveTasks();
                renderBoard();
            }
        }

        function exportData() {
            const data = {
                tasks: tasks,
                projects: projects
            };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "gtd_data.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        tasks = data.tasks || [];
                        projects = data.projects || [];
                        saveTasks();
                        saveProjects();
                        renderBoard();
                        renderProjectList();
                        populateProjectFilter();
                    } catch (error) {
                        alert('Error importing data. Please make sure the file is a valid JSON.');
                    }
                };
                reader.readAsText(file);
            }
        }

        function incrementPomodoro() {
            const pomodoroInput = document.getElementById('taskPomodoro');
            pomodoroInput.value = parseInt(pomodoroInput.value, 10) + 1;
        }

        function decrementPomodoro() {
            const pomodoroInput = document.getElementById('taskPomodoro');
            const currentValue = parseInt(pomodoroInput.value, 10);
            if (currentValue > 0) {
                pomodoroInput.value = currentValue - 1;
            }
        }

        function populateProjectFilter() {
            const projectFilter = document.getElementById('projectFilter');
            projectFilter.innerHTML = '<option value="">All Projects</option>';
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.name;
                option.textContent = project.name;
                projectFilter.appendChild(option);
            });
        }

        function applyFilter() {
            renderBoard();
        }

        function toggleArchive() {
            renderBoard();
        }

        // Initialize Quill editor, Flatpickr, and populate project filter
        document.addEventListener('DOMContentLoaded', function() {
            quill = new Quill('#editor-container', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['clean']
                    ]
                }
            });

            datepicker = flatpickr("#taskDate", {
                dateFormat: "d-m-Y",
                allowInput: true,
                locale: {
                 firstDayOfWeek: 1
                }
            });

            renderBoard();
            renderProjectList();
            populateProjectFilter();
        });
    </script>
</body>
</html>
